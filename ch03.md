# MYSQL Full Architecture

응용단에서는 DB에 요청하기 위한 커넥션 API들이 존재하고 있으며  
실제 DB에 접속 요청을 하는 경우를 적절한 제어하기 위한 커넥션 핸들러가 있다.  
Query를 수행하기 위한 인터페이스, Query를 해석하기 위한 파서,  
동작의 최소화와 성능을 위한 옵티마이저, 성능향상을 위한 SW 캐시등이 존재하며  
데이터 저장을 효율적으로 수행하기 위한 Storage Engine으로 구성된다.  
또한 최하단은 각각의 시스템 api를 호출하기 위해  
운영체제나 하드웨어와도 밀접한 연관을 가진다.  

# MYSQL Threading Architecture  

실제 서버 코드는 아래와 같이  
$(TOP)/sql/server_component/mysql_server_runnable_imp.cc에서  
main을 wrap하는 형식으로 호출된다.  

[MYSQL Server Main](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/sql/server_component/mysql_server_runnable_imp.cc#L37)

$(TOP)/sql/mysqld.cc에서 6569번 라인에서 mysqld_main() 코드를 살펴볼 수 있다.  

[mysqld_main()](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/sql/mysqld.cc#L6569)

여기서 눈여겨볼 부분은 my_init()이며  
$(TOP)/mysys/my_init.cc의 596번째 라인에 있다.  

[my_init()](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/mysys/my_init.cc#L130)

추가적으로 여기서 my_thread_global_init()과 my_thread_init()이 중요해보인다.  
my_thread_global_init()은 $(TOP)/mysys/my_thr_init.cc의 158번 라인에서 볼 수 있다.  

[my_thread_global_init()](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/mysys/my_thr_init.cc#L158)

코드를 살펴보면 pthread 기반의 코드임을 알 수 있다.  
해당 코드에선 동기 처리를 위한 Mutex를 준비하는 것을 볼 수 있다.  

또한 my_thread_init()은  
$(TOP)/mysys/my_thr_init.cc의 268번째 라인에서 볼 수 있다.  

[my_thread_init()](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/mysys/my_thr_init.cc#L268)

이 내부에서는 st_my_thread_var 구조체를 할당한다.  
구조체의 정의는 $(TOP)/mysys/my_thr_init.cc에 95번째 라인에 있다.  

[struct st_my_thread_var](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/mysys/my_thr_init.cc#L95)

구조체 내부의 my_thread_id라는 int 타입으로 정의는  
$(TOP)/include/my_thread_local.h에 있다.  

[my_thread_id](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/mysys/my_thr_init.cc#L95)

CODE_STATE라는 구조체는 $(TOP)/mysys/dbug.cc의 217번 라인에 정의되어 있다.  

[CODE_STATE](https://github.com/silenc3502/MYSQL-Arch-Doc-Summary/blob/main/mysql-server/mysys/dbug.cc#L217)

적어도 현재까지의 내용에 입각해서 해석해보자면  
책에서 이야기 한 프로세스 기반이 아닌 스레드 기반이란  
정확하게 멀티 프로세스 기반이 아닌  
멀티 스레드 기반의 코드라고 보는것이 맞을 것이다.  
(물론 현재 기준은 어디까지나 리눅스에 해당한다)  
